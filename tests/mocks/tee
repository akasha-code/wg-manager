#!/usr/bin/env bash
set -euo pipefail

# Minimal tee mock that redirects /etc and /usr/local/bin paths into $FAKE_ROOT

append=false
files=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -a)
      append=true; shift;;
    *)
      files+=("$1"); shift;;
  esac
done

# Read stdin to a temp buffer
buf=$(cat)

for f in "${files[@]}"; do
  target="$f"
  if [[ "${f#/etc/}" != "$f" ]]; then
    # rewrite to FAKE_ROOT if provided
    if [[ -n "${FAKE_ROOT:-}" ]]; then
      target="$FAKE_ROOT/${f#/}"
    fi
  elif [[ "${f#/usr/local/bin/}" != "$f" ]]; then
    if [[ -n "${FAKE_ROOT:-}" ]]; then
      target="$FAKE_ROOT/${f#/}"
    fi
  fi
  mkdir -p "$(dirname "$target")"
  if $append && [[ -f "$target" ]]; then
    printf "%s" "$buf" >>"$target"
  else
    printf "%s" "$buf" >"$target"
  fi
done

# Also echo to stdout like real tee
printf "%s" "$buf"

exit 0
